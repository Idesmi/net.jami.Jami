app-id: net.jami.Jami
runtime: org.gnome.Platform
runtime-version: '42'
sdk: org.gnome.Sdk
command: jami-gnome

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --device=all
  - --allow=per-app-dev-shm
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.gtk.vfs
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfsd
  - --own-name=org.mpris.MediaPlayer2.net.jami.Jami
  - --own-name=cx.ring.Ring
  - --metadata=X-DConf=migrate-path=/net/jami/JamiGnome/
  - --env=GTK_PATH=/app/lib/gtk-3.0

cleanup:
  - /bin/jami
  - "*.a"
  - "*.la"
  - "*.prl"
  - /lib/pkgconfig
  - /lib/cmake
  - /lib/mkspecs
  - /doc
  - /share/doc
  - /share/doc-doc
  - /share/gtk-doc
  - /share/gnome
  - /share/info
  - /share/man
  - /share/cmake
  - /share/gir-1.0
  - /share/pkgconfig
  - /share/vala
  - /share/gdm
  - /include
  - /bin/ring.cx
  - /lib/girepository-1.0

rename-desktop-file: jami-gnome.desktop
rename-appdata-file: jami-gnome.appdata.xml
rename-icon: jami-gnome

modules:
  - name: jami-gnome
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -Wno-dev
    sources:
      - type: git
        url: https://git.jami.net/savoirfairelinux/jami-client-gnome.git
        commit: d3f27548b5dac73734f660b19ded93ec1c51c84f
      - type: patch
        path: files/jami-client-gnome_appdata.patch
      - type: shell
        commands:
          - ln -sf /app/include/libringclient/web-chatview/* web
    modules:
      # opendht deps
      - dependencies/argon2.yml
      - dependencies/asio.yml
      - dependencies/jsoncpp.yml
      - dependencies/http-parser.yml
      - dependencies/fmt.yml
      - dependencies/restinio.yml # needs fmt, http-parser
      - dependencies/msgpack.yml
      # jami-daemon deps
      - dependencies/opendht.yml
      - dependencies/x264.yml
      - dependencies/dbus-c++.yml
      - dependencies/libsecp256k1.yml
      - dependencies/yaml-cpp.yml
      - dependencies/libupnp.yml
      - dependencies/libnatpmp.yml
      - dependencies/ffnvcodec.yml
      - dependencies/libgit2.yml
      - dependencies/webrtc-audio-processing.yml
      # libringclient deps
      - dependencies/jami-daemon.yml
      - dependencies/qtbase.yml
      - dependencies/qttools.yml # needs QTNetwork
      # jami-gnome deps
      - dependencies/jami-libclient.yml
      - dependencies/qt5compat.yml
      - dependencies/qrencode.yml
      - shared-modules/intltool/intltool-0.51.json
      - shared-modules/dbus-glib/dbus-glib-0.110.json
      - shared-modules/libcanberra/libcanberra.json
      - dependencies/mate-common.yml
      - dependencies/libdbusmenu.yml
      - dependencies/ayatana-ido.yml
      - dependencies/libayatana-indicator.yml
      - dependencies/libayatana-appindicator3.yml
      - dependencies/cogl.yml
      - dependencies/mtdev.yml
      - dependencies/libinput.yml # needs mtdev
      - dependencies/clutter.yml # needs libinput, cogl
      - dependencies/clutter-gtk.yml
