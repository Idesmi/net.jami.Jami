app-id: net.jami.Jami
base: io.qt.qtwebengine.BaseApp
base-version: '6.2'
runtime: org.kde.Platform
runtime-version: '6.2'
sdk: org.kde.Sdk
command: jami-qt

finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --allow=per-app-dev-shm
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.kde.StatusNotifierWatcher
  - --own-name=cx.ring.Ring
  - --own-name=org.mpris.MediaPlayer2.net.jami.Jami
  - --env=QML_IMPORT_PATH=/app/qml

cleanup:
  - "*.a"
  - "*.la"
  - /lib/pkgconfig
  - /lib/cmake
  - /lib/mkspecs
  - /include
  - /share/pixmaps
  - /share/man
  - /share/doc
  - /share/cmake
  - /share/jami-qt
  - /share/pkgconfig

cleanup-commands:
  - /app/cleanup-BaseApp.sh
  - rm -R /app/libexec

rename-desktop-file: jami-qt.desktop
rename-appdata-file: jami-qt.appdata.xml
rename-icon: jami

modules:
  - name: jami-client-qt
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      arch:
        x86_64:
          config-opts:
            - -DCMAKE_BUILD_TYPE=None
            - -Dqrencode=/app/lib/libqrencode.so
            - -D_qt_additional_packages_prefix_paths=/app/lib/x86_64-linux-gnu/cmake
        aarch64:
          config-opts:
            - -DCMAKE_BUILD_TYPE=None
            - -Dqrencode=/app/lib/libqrencode.so
            - -D_qt_additional_packages_prefix_paths=/app/lib/aarch64-linux-gnu/cmake
    sources:
      - type: git
        url: https://git.jami.net/savoirfairelinux/jami-client-qt.git
        commit: af0ae35680bd83a9d46a3648a4ea7609f6b48f76
        disable-submodules: true
      - type: patch
        path: patches/jami-client-qt_appdata.patch
      - type: patch
        path: patches/jami-client-qt_platformtheme.patch
    cleanup:
      - /bin/jami
    modules:
      # opendht deps
      - dependencies/boost.yml
      - dependencies/msgpack.yml
      - dependencies/argon2.yml
      - dependencies/asio.yml
      - dependencies/jsoncpp.yml
      - dependencies/http-parser.yml
      - dependencies/fmt.yml
      - dependencies/restinio.yml # needs fmt, http-parser
      # jami-daemon deps
      - dependencies/opendht.yml
      - dependencies/x264.yml
      - dependencies/ffnvcodec.yml
      - dependencies/libgit2.yml
      - dependencies/yaml-cpp.yml
      - dependencies/dbus-c++.yml
      - dependencies/libsecp256k1.yml
      - dependencies/libupnp.yml
      - dependencies/libnatpmp.yml
      - dependencies/webrtc-audio-processing.yml
      # jami-libclient deps
      - dependencies/jami-daemon.yml # ffmpeg needs x264, ffnvcodec
      # jami-client-qt deps
      - dependencies/jami-libclient.yml
      - dependencies/qt5compat.yml
      - dependencies/qrencode.yml
